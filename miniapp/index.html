<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>VPN PLUS</title>
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --bg-primary: #000000;
                --bg-card: #1c1c1e;
                --bg-card-hover: #2c2c2e;
                --text-primary: #ffffff;
                --text-secondary: #8e8e93;
                --accent: #a3e635;
                --accent-dark: #65a30d;
                --accent-glow: rgba(163, 230, 53, 0.3);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                min-height: 100vh;
                -webkit-font-smoothing: antialiased;
            }

            .container {
                max-width: 100%;
                padding: 0 16px 32px;
            }

            .header {
                text-align: center;
                padding: 10px 0 10px;
            }

            .logo-text {
                font-size: 42px;
                font-weight: 300;
                letter-spacing: 2px;
                font-style: italic;
            }

            .logo-text .accent {
                color: var(--accent);
                font-weight: 600;
            }

            .balance-card {
                background: var(--bg-card);
                border-radius: 16px;
                padding: 20px;
                margin-bottom: 12px;
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
            }

            .balance-info {
                flex: 1;
            }

            .balance-amount {
                display: flex;
                align-items: baseline;
                gap: 2px;
                margin-bottom: 8px;
            }

            .balance-value {
                font-size: 48px;
                font-weight: 300;
                line-height: 1;
            }

            .balance-currency {
                font-size: 24px;
                font-weight: 300;
                color: var(--text-secondary);
            }

            .tariff-text {
                font-size: 14px;
                color: var(--text-secondary);
                margin-bottom: 6px;
            }

            .topup-link {
                color: var(--accent);
                font-size: 14px;
                font-weight: 500;
                text-decoration: none;
                cursor: pointer;
            }

            .topup-link:hover {
                text-decoration: underline;
            }

            .topup-btn {
                width: 44px;
                height: 44px;
                background: var(--accent);
                border: none;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
                flex-shrink: 0;
                margin-top: 8px;
            }

            .topup-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 4px 20px var(--accent-glow);
            }

            .topup-btn:active {
                transform: scale(0.95);
            }

            .topup-btn svg {
                width: 24px;
                height: 24px;
                stroke: #fff;
                stroke-width: 2.5;
            }

            .setup-card {
                background: var(--accent);
                border-radius: 16px;
                padding: 18px 20px;
                margin-bottom: 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
            }

            .setup-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 30px var(--accent-glow);
            }

            .setup-card:active {
                transform: scale(0.98);
            }

            .setup-content h3 {
                font-size: 16px;
                font-weight: 600;
                color: #000;
                margin-bottom: 4px;
            }

            .setup-content p {
                font-size: 13px;
                color: rgba(0, 0, 0, 0.6);
            }

            .setup-arrow {
                width: 44px;
                height: 44px;
                background: rgba(0, 0, 0, 0.1);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .setup-arrow svg {
                width: 20px;
                height: 20px;
                stroke: #000;
                stroke-width: 2;
            }

            .info-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                margin-bottom: 12px;
            }

            .info-card {
                background: var(--bg-card);
                border-radius: 16px;
                padding: 16px 18px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .info-card:hover {
                background: var(--bg-card-hover);
            }

            .info-card:active {
                transform: scale(0.98);
            }

            .info-label {
                display: block;
                font-size: 14px;
                color: var(--text-secondary);
                margin-bottom: 6px;
            }

            .info-value {
                font-size: 18px;
                font-weight: 600;
            }

            .info-value.accent {
                color: var(--accent);
            }

            .support-card {
                background: var(--bg-card);
                border-radius: 16px;
                padding: 16px 18px;
                cursor: pointer;
                transition: background 0.2s;
            }

            .support-card:hover {
                background: var(--bg-card-hover);
            }

            .support-card:active {
                transform: scale(0.98);
            }

            .support-label {
                display: block;
                font-size: 14px;
                color: var(--text-secondary);
                margin-bottom: 4px;
            }

            .support-text {
                font-size: 15px;
                font-weight: 500;
            }

            .modal-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(10px);
                z-index: 1000;
                display: none;
                align-items: flex-end;
                justify-content: center;
            }

            .modal-overlay.active {
                display: flex;
                animation: fadeIn 0.2s ease;
            }

            .modal {
                background: var(--bg-card);
                border-radius: 20px 20px 0 0;
                width: 100%;
                max-width: 500px;
                max-height: 85vh;
                overflow-y: auto;
                animation: slideUp 0.3s ease;
            }

            .modal-header {
                padding: 20px 20px 16px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                background: var(--bg-card);
                z-index: 10;
            }

            .modal-header h3 {
                font-size: 18px;
                font-weight: 600;
            }

            .modal-close {
                width: 30px;
                height: 30px;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                font-size: 18px;
            }

            .modal-body {
                padding: 20px;
            }

            .amount-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-bottom: 16px;
            }

            .amount-option {
                padding: 16px 8px;
                background: rgba(255, 255, 255, 0.05);
                border: 2px solid transparent;
                border-radius: 12px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
            }

            .amount-option:hover {
                background: rgba(163, 230, 53, 0.1);
            }

            .amount-option.selected {
                border-color: var(--accent);
                background: rgba(163, 230, 53, 0.15);
            }

            .amount-option .amount {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .amount-option .days {
                font-size: 12px;
                color: var(--text-secondary);
            }

            .custom-amount-row {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            .custom-input {
                flex: 1;
                padding: 14px 16px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: var(--text-primary);
                font-size: 16px;
                font-family: inherit;
            }

            .custom-input:focus {
                outline: none;
                border-color: var(--accent);
            }

            .custom-input::placeholder {
                color: var(--text-secondary);
            }

            .pay-btn {
                width: 100%;
                padding: 16px;
                background: var(--accent);
                color: #000;
                border: none;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 600;
                font-family: inherit;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
            }

            .pay-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 24px var(--accent-glow);
            }

            .pay-btn:active {
                transform: scale(0.98);
            }

            .setup-steps {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .setup-step {
                display: flex;
                gap: 16px;
            }

            .step-number {
                width: 32px;
                height: 32px;
                background: var(--accent);
                color: #000;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 14px;
                flex-shrink: 0;
            }

            .step-content h4 {
                font-size: 15px;
                font-weight: 600;
                margin-bottom: 6px;
            }

            .step-content p {
                font-size: 14px;
                color: var(--text-secondary);
                margin-bottom: 12px;
            }

            .app-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .app-btn {
                padding: 8px 16px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                color: var(--text-primary);
                text-decoration: none;
                font-size: 13px;
                font-weight: 500;
                transition: background 0.2s;
            }

            .app-btn:hover {
                background: rgba(163, 230, 53, 0.2);
            }

            .copy-key-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                width: 100%;
                padding: 14px;
                background: var(--accent);
                color: #000;
                border: none;
                border-radius: 12px;
                font-size: 15px;
                font-weight: 600;
                font-family: inherit;
                cursor: pointer;
                transition: transform 0.2s;
            }

            .copy-key-btn:hover {
                transform: translateY(-2px);
            }

            .copy-key-btn:active {
                transform: scale(0.98);
            }

            .copy-key-btn svg {
                width: 18px;
                height: 18px;
                stroke: #000;
                stroke-width: 2;
                fill: none;
            }

            .referral-bonus-display {
                text-align: center;
                padding: 30px 0;
            }

            .referral-bonus-big {
                font-size: 48px;
                font-weight: 700;
                color: var(--accent);
                margin-bottom: 8px;
            }

            .referral-bonus-display p {
                color: var(--text-secondary);
                font-size: 14px;
            }

            .referral-link-box {
                display: flex;
                gap: 10px;
                margin: 20px 0;
            }

            .referral-input {
                flex: 1;
                padding: 14px 16px;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: var(--text-primary);
                font-size: 14px;
                font-family: inherit;
            }

            .copy-btn {
                width: 48px;
                height: 48px;
                background: var(--accent);
                border: none;
                border-radius: 12px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: transform 0.2s;
            }

            .copy-btn:hover {
                transform: scale(1.05);
            }

            .copy-btn svg {
                width: 20px;
                height: 20px;
                stroke: #000;
                stroke-width: 2;
                fill: none;
            }

            .share-btn {
                width: 100%;
                padding: 14px;
                background: transparent;
                border: 2px solid var(--accent);
                color: var(--accent);
                border-radius: 12px;
                font-size: 15px;
                font-weight: 600;
                font-family: inherit;
                cursor: pointer;
                transition: all 0.2s;
            }

            .share-btn:hover {
                background: rgba(163, 230, 53, 0.1);
            }

            .referral-stats {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
                margin-top: 24px;
                padding-top: 20px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .stat-item {
                text-align: center;
            }

            .stat-value {
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .stat-label {
                font-size: 13px;
                color: var(--text-secondary);
            }

            .devices-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .device-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 16px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
            }

            .device-info {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .device-icon {
                width: 40px;
                height: 40px;
                background: rgba(163, 230, 53, 0.15);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .device-icon svg {
                width: 22px;
                height: 22px;
                stroke: var(--accent);
                stroke-width: 1.5;
                fill: none;
            }

            .device-name {
                font-size: 15px;
                font-weight: 500;
            }

            .device-date {
                font-size: 12px;
                color: var(--text-secondary);
            }

            .device-remove {
                padding: 8px 14px;
                background: rgba(255, 71, 87, 0.15);
                color: #ff4757;
                border: none;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
            }

            .device-remove:hover {
                background: rgba(255, 71, 87, 0.25);
            }

            .empty-state {
                text-align: center;
                padding: 40px 20px;
                color: var(--text-secondary);
            }

            .support-options {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .support-option {
                display: flex;
                align-items: center;
                gap: 14px;
                padding: 16px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                text-decoration: none;
                color: var(--text-primary);
                transition: background 0.2s;
            }

            .support-option:hover {
                background: rgba(255, 255, 255, 0.1);
            }

            .option-icon {
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .option-icon svg {
                width: 20px;
                height: 20px;
                stroke: var(--accent);
            }

            .option-text {
                font-size: 15px;
                font-weight: 500;
            }

            .loading-overlay {
                position: fixed;
                inset: 0;
                background: var(--bg-primary);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            }

            .loading-overlay.hidden {
                display: none;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 3px solid rgba(255, 255, 255, 0.1);
                border-top-color: var(--accent);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            @keyframes slideDown {
                from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* –°—É—Ç–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ */
            .daily-subscription-status {
                background: var(--bg-card);
                border-radius: 16px;
                padding: 16px 18px;
                margin-bottom: 12px;
                border: 1px solid rgba(163, 230, 53, 0.2);
            }

            .daily-subscription-status.hidden {
                display: none;
            }

            .daily-subscription-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .daily-subscription-title {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                font-weight: 600;
            }

            .daily-icon {
                font-size: 18px;
            }

            .daily-subscription-price {
                font-size: 14px;
                font-weight: 600;
                color: var(--accent);
            }

            .daily-subscription-progress {
                margin-bottom: 12px;
                transition: opacity 0.3s ease;
            }

            .daily-subscription-progress.paused {
                opacity: 0.5;
            }

            .daily-progress-bar {
                height: 8px;
                background: rgba(163, 230, 53, 0.15);
                border-radius: 4px;
                overflow: hidden;
            }

            .daily-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, var(--accent), var(--accent-dark));
                border-radius: 4px;
                transition: width 0.3s ease;
            }

            .daily-subscription-progress.paused .daily-progress-fill {
                background: var(--text-secondary);
            }

            .daily-subscription-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 13px;
            }

            .daily-time-remaining {
                color: var(--text-secondary);
            }

            .daily-time-remaining strong {
                color: var(--text-primary);
                font-weight: 600;
            }

            .daily-next-charge {
                color: var(--text-secondary);
                font-size: 12px;
            }

            .daily-subscription-actions {
                margin-top: 12px;
            }

            .daily-pause-btn {
                width: 100%;
                padding: 12px 16px;
                border-radius: 12px;
                border: 2px solid rgba(163, 230, 53, 0.3);
                background: transparent;
                color: var(--text-primary);
                font-size: 14px;
                font-weight: 500;
                font-family: inherit;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .daily-pause-btn:hover {
                border-color: var(--accent);
                background: rgba(163, 230, 53, 0.1);
            }

            .daily-pause-btn.paused {
                background: var(--accent);
                color: #000;
                border-color: transparent;
            }

            .daily-pause-btn.paused:hover {
                opacity: 0.9;
            }

            .daily-pause-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .daily-paused-notice {
                margin-top: 12px;
                padding: 12px;
                background: rgba(245, 158, 11, 0.1);
                border: 1px solid rgba(245, 158, 11, 0.2);
                border-radius: 10px;
                display: flex;
                align-items: flex-start;
                gap: 10px;
                font-size: 13px;
                color: var(--text-secondary);
            }

            .daily-paused-notice.hidden {
                display: none;
            }

            .daily-paused-notice .notice-icon {
                font-size: 16px;
                flex-shrink: 0;
            }

            /* –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã */
            .payment-methods {
                margin-bottom: 16px;
            }

            .payment-methods-label {
                font-size: 13px;
                color: var(--text-secondary);
                margin-bottom: 10px;
            }

            .payment-methods-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .payment-method {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 14px;
                background: rgba(255, 255, 255, 0.05);
                border: 2px solid transparent;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .payment-method:hover {
                background: rgba(163, 230, 53, 0.1);
            }

            .payment-method.selected {
                border-color: var(--accent);
                background: rgba(163, 230, 53, 0.15);
            }

            .method-icon {
                font-size: 20px;
            }

            .method-name {
                font-size: 14px;
                font-weight: 500;
            }

            .method-description {
                font-size: 12px;
                color: var(--text-secondary);
            }

            .payment-methods-loading {
                text-align: center;
                padding: 20px;
                color: var(--text-secondary);
                font-size: 14px;
            }

            /* –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π */
            .history-list {
                display: flex;
                flex-direction: column;
                gap: 0;
            }

            .history-item {
                padding: 14px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }

            .history-item:last-child {
                border-bottom: none;
            }

            .history-item-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 6px;
            }

            .history-amount {
                font-size: 18px;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .history-amount.positive {
                color: #10b981;
            }

            .history-amount.negative {
                color: #ef4444;
            }

            .history-amount-icon {
                width: 18px;
                height: 18px;
            }

            .history-type {
                font-size: 12px;
                font-weight: 600;
                color: var(--text-primary);
                padding: 4px 10px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 6px;
            }

            .history-meta {
                font-size: 12px;
                color: var(--text-secondary);
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .history-description {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 8px;
                padding: 8px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 8px;
            }

            .history-empty {
                text-align: center;
                padding: 40px 20px;
                color: var(--text-secondary);
            }
        </style>
    </head>
    <body>
        <div class="loading-overlay" id="loading">
            <div class="spinner"></div>
        </div>

        <div class="container">
            <header class="header">
                <img
                    src="/logo.png"
                    alt="VPN PLUS"
                    style="max-width: 300px; height: auto"
                />
            </header>

            <section class="balance-card" id="balance-section">
                <div class="balance-info">
                    <div class="balance-amount">
                        <span class="balance-value" id="balanceAmount">0</span>
                        <span class="balance-currency">‚ÇΩ</span>
                    </div>
                    <div class="tariff-text" id="tariff-text">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞—Ä–∏—Ñ–∞...
                    </div>
                    <a class="topup-link" id="topup-link">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</a>
                </div>
                <button class="topup-btn" id="topup-btn">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path
                            d="M12 5v14M5 12h14"
                            stroke="#ffffff"
                            stroke-width="2.5"
                            stroke-linecap="round"
                        />
                    </svg>
                </button>
            </section>

            <section class="setup-card" id="setup-btn">
                <div class="setup-content">
                    <h3>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
                    <p>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —à–∞–≥–∞–º</p>
                </div>
                <div class="setup-arrow">
                    <svg viewBox="0 0 24 24" fill="none">
                        <path
                            d="M9 6l6 6-6 6"
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                </div>
            </section>

            <section class="info-row">
                <div class="info-card" id="referral-btn">
                    <span class="info-label">–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</span>
                    <span class="info-value accent" id="referral-bonus"
                        >+30‚ÇΩ</span
                    >
                </div>
                <div class="info-card" id="devices-btn">
                    <span class="info-label">–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</span>
                    <span class="info-value" id="devices-count">0</span>
                </div>
            </section>

            <section class="support-card" id="support-btn">
                <span class="support-label">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                <span class="support-text">–ü–æ–º–æ—â—å, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –ø–ª–∞—Ç–µ–∂–∏</span>
            </section>
        </div>

        <div class="modal-overlay" id="topup-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3>
                    <button class="modal-close" id="close-topup">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <!-- –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã -->
                    <div class="payment-methods" id="payment-methods">
                        <div class="payment-methods-label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
                        <div class="payment-methods-list" id="payment-methods-list">
                            <!-- –ú–µ—Ç–æ–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            <div class="payment-method selected" data-method="yookassa">
                                <span class="method-icon">üí≥</span>
                                <span class="method-name">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="amount-grid">
                        <div class="amount-option" data-amount="100">
                            <div class="amount">100‚ÇΩ</div>
                            <div class="days">20 –¥–Ω–µ–π</div>
                        </div>
                        <div class="amount-option" data-amount="300">
                            <div class="amount">300‚ÇΩ</div>
                            <div class="days">60 –¥–Ω–µ–π</div>
                        </div>
                        <div class="amount-option selected" data-amount="500">
                            <div class="amount">500‚ÇΩ</div>
                            <div class="days">100 –¥–Ω–µ–π</div>
                        </div>
                    </div>
                    <div class="custom-amount-row">
                        <input
                            type="number"
                            class="custom-input"
                            id="custom-amount"
                            placeholder="–î—Ä—É–≥–∞—è —Å—É–º–º–∞"
                            min="50"
                        />
                    </div>
                    <button class="pay-btn" id="pay-btn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="setup-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ VPN</h3>
                    <button class="modal-close" id="close-setup">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="setup-steps">
                        <div class="setup-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>–°–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h4>
                                <p>
                                    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                                    <b style="color: white">Happ Proxy</b> –¥–ª—è
                                    –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                                </p>
                                <div class="app-buttons">
                                    <a
                                        href="https://apps.apple.com/app/id6746188973"
                                        class="app-btn"
                                        id="app-ios"
                                        >iOS</a
                                    >
                                    <a
                                        href="https://play.google.com/store/apps/details?id=com.happproxy"
                                        class="app-btn"
                                        id="app-android"
                                        >Android</a
                                    >
                                    <a
                                        href="https://github.com/Happ-proxy/happ-desktop/releases/latest/download/setup-Happ.x64.exe"
                                        class="app-btn"
                                        id="app-windows"
                                        >Windows</a
                                    >
                                    <a
                                        href="https://apps.apple.com/ru/app/v2box-v2ray-client/id6446814690"
                                        class="app-btn"
                                        id="app-macos"
                                        >macOS</a
                                    >
                                </div>
                            </div>
                        </div>
                        <div class="setup-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á</h4>
                                <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                                <button class="copy-key-btn" id="copy-key-btn">
                                    <span>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</span>
                                    <svg viewBox="0 0 24 24">
                                        <rect
                                            x="9"
                                            y="9"
                                            width="13"
                                            height="13"
                                            rx="2"
                                        />
                                        <path
                                            d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"
                                        />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="setup-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h4>
                                <p>
                                    –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                                    –ø–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∫–ª—é—á—É
                                </p>
                                <img
                                    src="/image.jpg"
                                    alt="–ü—Ä–∏–º–µ—Ä –≤—Å—Ç–∞–≤–∫–∏ –∫–ª—é—á–∞"
                                    style="
                                        width: 100%;
                                        border-radius: 12px;
                                        margin-top: 12px;
                                    "
                                />
                            </div>
                        </div>
                        <div class="setup-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä</h4>
                                <p>
                                    –í—ã–±–∏—Ä–∞–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≤–∞—à–µ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç–µ—Å—å
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="referral-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞</h3>
                    <button class="modal-close" id="close-referral">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="referral-bonus-display">
                        <div class="referral-bonus-big">+30‚ÇΩ</div>
                        <p>–∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞</p>
                    </div>
                    <div class="referral-link-box">
                        <input
                            type="text"
                            class="referral-input"
                            id="referral-link"
                            readonly
                            value="–ó–∞–≥—Ä—É–∑–∫–∞..."
                        />
                        <button class="copy-btn" id="copy-referral">
                            <svg viewBox="0 0 24 24">
                                <rect
                                    x="9"
                                    y="9"
                                    width="13"
                                    height="13"
                                    rx="2"
                                />
                                <path
                                    d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"
                                />
                            </svg>
                        </button>
                    </div>
                    <button class="share-btn" id="share-btn">
                        –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
                    </button>
                    <div class="referral-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="referral-count">0</div>
                            <div class="stat-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="referral-earned">
                                0‚ÇΩ
                            </div>
                            <div class="stat-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="devices-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
                    <button class="modal-close" id="close-devices">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="devices-list" id="devices-list">
                        <div class="empty-state">
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="support-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
                    <button class="modal-close" id="close-support">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="support-options">
                        <a href="#" class="support-option" id="faq-link">
                            <span class="option-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9 9a3 3 0 1 1 4 2.83V13"/>
                                    <circle cx="12" cy="17" r="0.5" fill="currentColor"/>
                                </svg>
                            </span>
                            <span class="option-text">–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)</span>
                        </a>
                        <a href="#" class="support-option" id="docs-link">
                            <span class="option-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                                    <line x1="8" y1="7" x2="16" y2="7"/>
                                    <line x1="8" y1="11" x2="14" y2="11"/>
                                </svg>
                            </span>
                            <span class="option-text">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</span>
                        </a>
                        <a href="#" class="support-option" id="payments-link">
                            <span class="option-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="2" y="5" width="20" height="14" rx="2"/>
                                    <line x1="2" y1="10" x2="22" y2="10"/>
                                    <line x1="6" y1="15" x2="10" y2="15"/>
                                </svg>
                            </span>
                            <span class="option-text">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</span>
                        </a>
                        <a href="https://t.me/plusvpnsupport" class="support-option" id="contact-link">
                            <span class="option-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                                </svg>
                            </span>
                            <span class="option-text">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π -->
        <div class="modal-overlay" id="history-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                    <button class="modal-close" id="close-history">
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="history-list" id="history-list">
                        <div class="empty-state">
                            <p>–û–ø–µ—Ä–∞—Ü–∏–∏ –µ—â—ë –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∏—Å—å</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const tg = window.Telegram?.WebApp;
            let userData = null;
            let selectedAmount = 500;
            let selectedPaymentMethod = 'yookassa'; // –ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            let availablePaymentMethods = [];
            let dailyTimerInterval = null;
            let balancePollingInterval = null;
            let lastKnownBalance = null;

            document.addEventListener("DOMContentLoaded", async () => {
                if (tg) {
                    tg.ready();
                    tg.expand();
                    tg.setHeaderColor("#000000");
                    tg.setBackgroundColor("#000000");
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                try {
                    await Promise.all([
                        loadUserData(),
                        loadPaymentMethods()
                    ]);
                } catch (error) {
                    console.error("Failed to load initial data:", error);
                }
                
                setupEventListeners();
                document.getElementById("loading").classList.add("hidden");
            });

            async function loadUserData() {
                const initData = tg?.initData || '';
                
                if (!initData) {
                    console.log("No Telegram init data");
                    return;
                }

                try {
                    const response = await fetch("/miniapp/subscription", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ initData: initData }),
                    });

                    if (response.ok) {
                        userData = await response.json();
                        
                        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º miniapp)
                        userData.subscriptionUrl = userData.subscription_url || null;
                        userData.subscriptionCryptoLink = userData.subscription_crypto_link || null;
                        userData.referral = userData.referral || null;
                        
                        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
                        const newBalance = userData.balance_kopeks ?? userData.user?.balance_kopeks ?? 0;
                        if (lastKnownBalance !== null && newBalance > lastKnownBalance) {
                            showBalanceUpdate(newBalance - lastKnownBalance);
                        }
                        lastKnownBalance = newBalance;
                        
                        updateUI();
                        renderDailySubscriptionStatus();
                    } else {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                        let errorMessage = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData?.detail?.message || errorData?.detail || errorData?.message || errorMessage;
                        } catch (e) {}
                        console.error("Load user data error:", response.status, errorMessage);
                    }
                } catch (error) {
                    console.error("Failed to load user data:", error);
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã
            async function loadPaymentMethods() {
                try {
                    const response = await fetch("/miniapp/payments/methods", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ initData: tg?.initData }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        availablePaymentMethods = data.methods || data || [];
                        renderPaymentMethods();
                    }
                } catch (error) {
                    console.error("Failed to load payment methods:", error);
                }
            }

            function renderPaymentMethods() {
                const container = document.getElementById("payment-methods-list");
                if (!container) return;

                if (!availablePaymentMethods || availablePaymentMethods.length === 0) {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –º–µ—Ç–æ–¥
                    return;
                }

                const methodIcons = {
                    'yookassa': 'üí≥',
                    'yookassa_sbp': 'üè¶',
                    'stars': '‚≠ê',
                    'cryptobot': 'ü™ô',
                    'heleket': 'üí∞',
                    'tribute': 'üíé',
                    'pal24': 'üèß',
                    'wata': 'üí≥',
                    'freekassa': 'üíµ',
                    'cloudpayments': '‚òÅÔ∏è',
                    'mulenpay': 'üí≥',
                };

                const methodNames = {
                    'yookassa': '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞',
                    'yookassa_sbp': '–°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)',
                    'stars': 'Telegram Stars',
                    'cryptobot': '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ (CryptoBot)',
                    'heleket': 'Heleket',
                    'tribute': 'Tribute',
                    'pal24': 'PAL24',
                    'wata': 'WATA',
                    'freekassa': 'Freekassa',
                    'cloudpayments': 'CloudPayments',
                    'mulenpay': 'Mulen Pay',
                };

                container.innerHTML = availablePaymentMethods
                    .filter(method => method.enabled !== false)
                    .map((method, index) => {
                        const methodId = method.id || method.method || method;
                        const icon = methodIcons[methodId] || 'üí≥';
                        const name = method.title || method.name || methodNames[methodId] || methodId;
                        const isSelected = index === 0 || methodId === selectedPaymentMethod;
                        
                        if (isSelected) {
                            selectedPaymentMethod = methodId;
                        }
                        
                        return `
                            <div class="payment-method ${isSelected ? 'selected' : ''}" data-method="${methodId}">
                                <span class="method-icon">${icon}</span>
                                <div>
                                    <span class="method-name">${name}</span>
                                    ${method.description ? `<div class="method-description">${method.description}</div>` : ''}
                                </div>
                            </div>
                        `;
                    })
                    .join("");

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞
                container.querySelectorAll(".payment-method").forEach(el => {
                    el.addEventListener("click", () => {
                        container.querySelectorAll(".payment-method").forEach(m => m.classList.remove("selected"));
                        el.classList.add("selected");
                        selectedPaymentMethod = el.dataset.method;
                    });
                });
            }

            function startBalancePolling() {
                if (balancePollingInterval) return;
                balancePollingInterval = setInterval(loadUserData, 3000);
                setTimeout(stopBalancePolling, 120000);
            }

            function stopBalancePolling() {
                if (balancePollingInterval) {
                    clearInterval(balancePollingInterval);
                    balancePollingInterval = null;
                }
            }

            function showBalanceUpdate(amountKopeks) {
                const rubles = Math.floor(amountKopeks / 100);
                const notification = document.createElement('div');
                notification.className = 'balance-notification';
                notification.innerHTML = `<span>+${rubles} ‚ÇΩ</span>`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--accent);
                    color: #000;
                    padding: 12px 24px;
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 18px;
                    z-index: 9999;
                    animation: slideDown 0.3s ease;
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }

            function updateUI() {
                if (!userData) return;

                const user = userData.user;
                
                // –ë–∞–ª–∞–Ω—Å (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º balance_rubles –∏–∑ –∫–æ—Ä–Ω—è –æ—Ç–≤–µ—Ç–∞)
                renderBalanceSection();

                // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º connected_devices)
                renderDevicesList();

                // –¢–∞—Ä–∏—Ñ - —Å—É—Ç–æ—á–Ω—ã–π —Ä–µ–∂–∏–º
                const tariffEl = document.getElementById("tariff-text");
                const isDailyTariff = user?.is_daily_tariff ?? user?.isDailyTariff ?? false;
                const dailyPriceLabel = user?.daily_price_label ?? user?.dailyPriceLabel ?? '';
                const dailyPrice = user?.daily_price ?? userData?.daily_price;
                
                if (isDailyTariff && dailyPriceLabel) {
                    tariffEl.textContent = `–°—É—Ç–æ—á–Ω—ã–π —Ç–∞—Ä–∏—Ñ: ${dailyPriceLabel}`;
                } else if (dailyPrice !== undefined) {
                    tariffEl.textContent = `–¢–∞—Ä–∏—Ñ ${dailyPrice}‚ÇΩ/–¥–µ–Ω—å –∑–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ`;
                } else {
                    tariffEl.textContent = "–¢–∞—Ä–∏—Ñ 6‚ÇΩ/–¥–µ–Ω—å –∑–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ";
                }

                // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
                renderReferralSection();

                // –ö–ª—é—á –ø–æ–¥–ø–∏—Å–∫–∏
                const subscriptionKey = userData.subscription_url ?? userData.subscriptionUrl ?? userData.subscription_key;
                if (subscriptionKey) {
                    userData.subscription_key = subscriptionKey;
                }
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º miniapp/index.html)
            function renderReferralSection() {
                const data = userData?.referral;
                
                if (!data) {
                    console.log("No referral data");
                    return;
                }
                
                console.log("Referral data:", data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: referral_link, –∑–∞—Ç–µ–º referral_code
                const linkInput = document.getElementById('referral-link');
                const link = data.referral_link || '';  // –ü–æ–ª–Ω–∞—è —Å—Å—ã–ª–∫–∞ https://t.me/bot?start=code
                const code = data.referral_code || '';  // –¢–æ–ª—å–∫–æ –∫–æ–¥
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—É—é —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                const copyTarget = link || code;
                
                if (linkInput) {
                    linkInput.value = copyTarget || '–ó–∞–≥—Ä—É–∑–∫–∞...';
                }

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ data.stats
                const stats = data.stats || {};
                
                // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö
                const invitedCount = stats.invited_count ?? 0;
                const countEl = document.getElementById('referral-count');
                if (countEl) {
                    countEl.textContent = invitedCount;
                }

                // –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
                const totalEarnedLabel = stats.total_earned_label;
                const totalEarnedKopeks = stats.total_earned_kopeks ?? 0;
                const earnedEl = document.getElementById('referral-earned');
                if (earnedEl) {
                    if (totalEarnedLabel) {
                        earnedEl.textContent = totalEarnedLabel;
                    } else {
                        const rubles = Math.floor(totalEarnedKopeks / 100);
                        earnedEl.textContent = `${rubles}‚ÇΩ`;
                    }
                }

                // –ë–æ–Ω—É—Å –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∏–∑ terms
                const terms = data.terms || {};
                const inviterBonusKopeks = terms.inviter_bonus_kopeks ?? 3000; // 30‚ÇΩ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const bonusRubles = Math.floor(inviterBonusKopeks / 100);
                
                const bonusEl = document.getElementById('referral-bonus');
                if (bonusEl) {
                    bonusEl.textContent = `+${bonusRubles}‚ÇΩ`;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å –≤ –º–æ–¥–∞–ª–∫–µ
                const bonusBigEl = document.querySelector('.referral-bonus-big');
                if (bonusBigEl) {
                    bonusBigEl.textContent = `+${bonusRubles}‚ÇΩ`;
                }
            }

            // ============================================================
            // –°—É—Ç–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            // ============================================================
            function renderDailySubscriptionStatus() {
                const container = document.getElementById('daily-subscription-status');
                if (!container) return;

                const user = userData?.user;
                if (!user) {
                    container.classList.add('hidden');
                    return;
                }

                const isDailyTariff = user.is_daily_tariff ?? user.isDailyTariff ?? false;
                const isDailyPaused = user.is_daily_paused ?? user.isDailyPaused ?? false;
                const dailyTariffName = user.daily_tariff_name ?? user.dailyTariffName ?? '–°—É—Ç–æ—á–Ω—ã–π —Ç–∞—Ä–∏—Ñ';
                const dailyPriceLabel = user.daily_price_label ?? user.dailyPriceLabel ?? '';
                const dailyNextChargeAt = user.daily_next_charge_at ?? user.dailyNextChargeAt ?? null;

                if (!isDailyTariff) {
                    container.classList.add('hidden');
                    if (dailyTimerInterval) {
                        clearInterval(dailyTimerInterval);
                        dailyTimerInterval = null;
                    }
                    return;
                }

                container.classList.remove('hidden');

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                const tariffNameEl = document.getElementById('daily-tariff-name');
                if (tariffNameEl) {
                    tariffNameEl.textContent = dailyTariffName;
                }

                const priceEl = document.getElementById('daily-price');
                if (priceEl && dailyPriceLabel) {
                    priceEl.textContent = dailyPriceLabel;
                }

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–∞—É–∑—ã
                const pauseBtn = document.getElementById('daily-pause-btn');
                const pauseBtnIcon = document.getElementById('daily-pause-icon');
                const pauseBtnText = document.getElementById('daily-pause-text');
                const pausedNotice = document.getElementById('daily-paused-notice');
                const progressSection = document.getElementById('daily-progress-section');

                if (isDailyPaused) {
                    pauseBtn?.classList.add('paused');
                    if (pauseBtnIcon) pauseBtnIcon.textContent = '‚ñ∂Ô∏è';
                    if (pauseBtnText) pauseBtnText.textContent = '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å';
                    pausedNotice?.classList.remove('hidden');
                    progressSection?.classList.add('paused');
                } else {
                    pauseBtn?.classList.remove('paused');
                    if (pauseBtnIcon) pauseBtnIcon.textContent = '‚è∏Ô∏è';
                    if (pauseBtnText) pauseBtnText.textContent = '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
                    pausedNotice?.classList.add('hidden');
                    progressSection?.classList.remove('paused');
                }

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–∞—É–∑—ã
                if (pauseBtn) {
                    pauseBtn.onclick = () => toggleDailyPause();
                }

                // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
                startDailyCountdownTimer(dailyNextChargeAt, isDailyPaused);
            }

            function startDailyCountdownTimer(nextChargeAt, isPaused) {
                if (dailyTimerInterval) {
                    clearInterval(dailyTimerInterval);
                    dailyTimerInterval = null;
                }

                const timeRemainingEl = document.getElementById('daily-time-remaining');
                const progressFill = document.getElementById('daily-progress-fill');
                const nextChargeEl = document.getElementById('daily-next-charge');

                if (!nextChargeAt) {
                    if (timeRemainingEl) timeRemainingEl.textContent = '--:--:--';
                    if (progressFill) progressFill.style.width = '0%';
                    if (nextChargeEl) nextChargeEl.textContent = '';
                    return;
                }

                const utcDateStr = String(nextChargeAt).endsWith('Z') ? nextChargeAt : nextChargeAt + 'Z';
                const nextChargeDate = new Date(utcDateStr);
                const totalDuration = 24 * 60 * 60 * 1000;

                function updateTimer() {
                    const now = new Date();
                    const remaining = nextChargeDate - now;

                    if (remaining <= 0) {
                        if (timeRemainingEl) timeRemainingEl.textContent = '00:00:00';
                        if (progressFill) progressFill.style.width = '0%';
                        clearInterval(dailyTimerInterval);
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–≥–¥–∞ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ
                        setTimeout(loadUserData, 2000);
                        return;
                    }

                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                    const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    if (timeRemainingEl) timeRemainingEl.textContent = timeStr;

                    const progressPercent = Math.max(0, Math.min(100, (remaining / totalDuration) * 100));
                    if (progressFill) progressFill.style.width = `${progressPercent}%`;

                    if (nextChargeEl) {
                        if (isPaused) {
                            nextChargeEl.textContent = '–ü–∞—É–∑–∞ ‚Äî –±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è';
                        } else {
                            const chargeTime = nextChargeDate.toLocaleTimeString('ru-RU', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            nextChargeEl.textContent = `–°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ ${chargeTime}`;
                        }
                    }
                }

                updateTimer();
                if (!isPaused) {
                    dailyTimerInterval = setInterval(updateTimer, 1000);
                }
            }

            async function toggleDailyPause() {
                const pauseBtn = document.getElementById('daily-pause-btn');
                if (!pauseBtn || pauseBtn.disabled) return;

                pauseBtn.disabled = true;
                const originalText = pauseBtn.innerHTML;
                pauseBtn.innerHTML = '<span>‚è≥</span><span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>';

                try {
                    const response = await fetch('/miniapp/subscription/daily/toggle-pause', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ init_data: tg?.initData })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        const errorCode = result?.detail?.code || 'unknown';
                        let errorMsg = result?.detail?.message || result?.error || '–û—à–∏–±–∫–∞';
                        
                        if (errorCode === 'insufficient_balance') {
                            errorMsg = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏';
                        }
                        
                        showAlert(errorMsg);
                        return;
                    }

                    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
                    await loadUserData();

                } catch (error) {
                    console.error('Error toggling daily pause:', error);
                    showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                } finally {
                    if (pauseBtn) {
                        pauseBtn.disabled = false;
                    }
                }
            }

            function showAlert(message) {
                if (tg?.showAlert) {
                    tg.showAlert(message);
                    } else {
                    alert(message);
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
            function escapeHtml(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
            function formatDateTime(dateStr) {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return '';
                }
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
            function formatCurrency(amount, currency = 'RUB') {
                const symbols = { 'RUB': '‚ÇΩ', 'USD': '$', 'EUR': '‚Ç¨' };
                const symbol = symbols[currency] || currency;
                return `${amount.toFixed(0)} ${symbol}`;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–µ–∫—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–∞ (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º miniapp/index.html)
            function renderBalanceSection() {
                const amountElement = document.getElementById('balanceAmount');
                if (!amountElement) {
                    console.log("Balance element not found");
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ userData (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ - balance_rubles)
                const balanceRubles = typeof userData?.balance_rubles === 'number'
                    ? userData.balance_rubles
                    : Number.parseFloat(userData?.balance_rubles ?? '0');
                
                const currency = (userData?.balance_currency || 'RUB').toUpperCase();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ, –±–µ–∑ –≤–∞–ª—é—Ç—ã - –æ–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ)
                amountElement.textContent = Math.floor(balanceRubles);
                
                console.log("Balance rendered:", balanceRubles, currency);
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
            function renderTransactionHistory() {
                const list = document.getElementById('history-list');
                if (!list) return;

                const transactions = Array.isArray(userData?.transactions) ? userData.transactions : [];
                
                if (!transactions.length) {
                    list.innerHTML = '<div class="history-empty"><p>–û–ø–µ—Ä–∞—Ü–∏–∏ –µ—â—ë –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–∏—Å—å</p></div>';
                    return;
                }

                const currency = (userData?.balance_currency || 'RUB').toUpperCase();
                const negativeTypes = new Set(['withdrawal', 'subscription_payment', 'daily_charge']);

                const typeLabels = {
                    'deposit': '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
                    'withdrawal': '–°–ø–∏—Å–∞–Ω–∏–µ',
                    'subscription_payment': '–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏',
                    'daily_charge': '–°—É—Ç–æ—á–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ',
                    'refund': '–í–æ–∑–≤—Ä–∞—Ç',
                    'referral_reward': '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å',
                    'bonus': '–ë–æ–Ω—É—Å',
                    'promo': '–ü—Ä–æ–º–æ–∫–æ–¥'
                };

                const statusLabels = {
                    true: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
                    false: '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è'
                };

                const itemsHtml = transactions.map(tx => {
                    const type = (tx.type || '').toLowerCase();
                    const typeLabel = typeLabels[type] || type.replace(/_/g, ' ');
                    
                    const amountRaw = typeof tx.amount_kopeks === 'number'
                        ? tx.amount_kopeks
                        : parseInt(tx.amount_kopeks || '0', 10);
                    const amountValue = Number.isFinite(amountRaw) ? amountRaw / 100 : 0;
                    const isNegative = amountValue < 0 || negativeTypes.has(type);
                    const amountFormatted = `${isNegative ? '‚àí' : '+'}${formatCurrency(Math.abs(amountValue), currency)}`;
                    
                    const statusLabel = statusLabels[tx.is_completed] || '';
                    
                    const metaParts = [];
                    const createdAt = formatDateTime(tx.created_at);
                    if (createdAt) {
                        metaParts.push(escapeHtml(createdAt));
                    }
                    if (statusLabel) {
                        metaParts.push(escapeHtml(statusLabel));
                    }
                    const metaHtml = metaParts.length ? `<div class="history-meta">${metaParts.join(' ‚Ä¢ ')}</div>` : '';
                    
                    const descriptionHtml = tx.description
                        ? `<div class="history-description">${escapeHtml(tx.description)}</div>`
                        : '';
                    
                    const amountClass = isNegative ? 'history-amount negative' : 'history-amount positive';
                    const iconHtml = isNegative
                        ? '<svg class="history-amount-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>'
                        : '<svg class="history-amount-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>';

                    return `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="${amountClass}">${iconHtml}${amountFormatted}</span>
                                <span class="history-type">${escapeHtml(typeLabel)}</span>
                            </div>
                            ${metaHtml}
                            ${descriptionHtml}
                        </div>
                    `;
                }).join('');

                list.innerHTML = itemsHtml;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º miniapp/index.html)
            function renderDevicesList() {
                const list = document.getElementById('devices-list');
                if (!list) return;

                const devices = Array.isArray(userData?.connected_devices)
                    ? userData.connected_devices
                    : [];

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
                const countEl = document.getElementById('devices-count');
                if (countEl) {
                    countEl.textContent = devices.length;
                }

                if (!devices.length) {
                    list.innerHTML = '<div class="empty-state"><p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</p></div>';
                    return;
                }

                list.innerHTML = devices.map(device => {
                    const platform = device?.platform ? String(device.platform) : '';
                    const model = device?.device_model ? String(device.device_model) : '';
                    const titleParts = [platform, model].filter(Boolean);
                    const title = titleParts.length ? titleParts.join(' ‚Äî ') : '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';

                    const metaParts = [];
                    if (device?.app_version) {
                        metaParts.push(String(device.app_version));
                    }
                    if (device?.last_seen) {
                        const formatted = formatDateTime(device.last_seen);
                        if (formatted) metaParts.push(formatted);
                    }
                    if (device?.last_ip) {
                        metaParts.push(String(device.last_ip));
                    }
                    const metaText = metaParts.join(' ‚Ä¢ ');

                    const deviceHwid = device?.hwid ? String(device.hwid) : '';
                            const platformIcons = {
                        Android: '<path d="M17 2H7c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H7V4h10v16z"/>',
                                iOS: '<path d="M15.5 1h-8A2.5 2.5 0 005 3.5v17A2.5 2.5 0 007.5 23h8a2.5 2.5 0 002.5-2.5v-17A2.5 2.5 0 0015.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"/>',
                        Windows: '<path d="M3 12V6.5l7-1v6.5H3zm0 .5h7v6.5l-7-1V12.5zM10.5 5l9.5-1.5v9h-9.5V5zm0 7.5h9.5v9L10.5 20v-7.5z"/>',
                                macOS: '<path d="M4 4h16a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V6a2 2 0 012-2zm8 14v2m-4 0h8"/>',
                        Linux: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>'
                    };
                    const icon = platformIcons[platform] || '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>';

                            return `
                        <div class="device-item" data-hwid="${escapeHtml(deviceHwid)}">
                                <div class="device-info">
                                    <div class="device-icon">
                                        <svg viewBox="0 0 24 24">${icon}</svg>
                                    </div>
                                    <div>
                                    <div class="device-name">${escapeHtml(title)}</div>
                                    <div class="device-date">${escapeHtml(metaText)}</div>
                                    </div>
                                </div>
                            ${deviceHwid ? `<button class="device-remove" data-hwid="${escapeHtml(deviceHwid)}" data-label="${escapeHtml(title)}">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                            </div>
                        `;
                }).join('');

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                list.querySelectorAll('.device-remove').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const hwid = button.dataset.hwid;
                        const label = button.dataset.label;
                        handleDeviceRemoval(hwid, label, button);
                    });
                });
            }

            async function handleDeviceRemoval(hwid, deviceName, button) {
                const normalizedHwid = typeof hwid === 'string' ? hwid.trim() : '';
                if (!normalizedHwid) {
                    showAlert("–û—à–∏–±–∫–∞: —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
                    return;
                }

                if (!confirm(`–£–¥–∞–ª–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "${deviceName}"?`)) {
                    return;
                }

                const initData = tg?.initData || '';
                if (!initData) {
                    showAlert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                if (button) {
                    button.disabled = true;
                    button.textContent = '...';
                }

                try {
                    const response = await fetch('/miniapp/devices/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData, hwid: normalizedHwid })
                    });

                    let payload = null;
                    try {
                        payload = await response.json();
                    } catch (e) {
                        payload = null;
                    }

                    if (!response.ok || (payload && payload.success === false)) {
                        const message = payload?.message
                            || payload?.detail?.message
                            || payload?.detail
                            || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞";
                        showAlert(typeof message === 'string' ? message : "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞");
                        return;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    if (Array.isArray(userData?.connected_devices)) {
                        userData.connected_devices = userData.connected_devices.filter(d => {
                            const deviceHwid = d?.hwid ? String(d.hwid).trim() : '';
                            return deviceHwid !== normalizedHwid;
                        });
                    }

                    renderDevicesList();
                    showAlert("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ");

                } catch (error) {
                    console.error("Device removal error:", error);
                    showAlert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.textContent = '–£–¥–∞–ª–∏—Ç—å';
                    }
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
            async function handleSetupClick() {
                console.log("handleSetupClick called");
                console.log("userData:", userData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
                const user = userData?.user || userData;
                const subscriptionId = user?.subscription_id || user?.subscriptionId;
                const subscriptionUrl = userData?.subscription_url;
                const hasSubscription = subscriptionId || subscriptionUrl;
                
                console.log("user:", user);
                console.log("subscription_id:", subscriptionId);
                console.log("subscription_url:", subscriptionUrl);
                console.log("hasSubscription:", hasSubscription);
                
                if (hasSubscription) {
                    // –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –µ—Å—Ç—å - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                    console.log("Opening setup modal (subscription exists)");
                    openModal("setup-modal");
                } else {
                    // –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—É—Ç–æ—á–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
                    console.log("Activating daily subscription...");
                    await activateDailySubscription();
                }
            }

            // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å—É—Ç–æ—á–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
            async function activateDailySubscription() {
                const initData = tg.initData || "";
                if (!initData) {
                    showAlert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const loadingEl = document.getElementById("loading");
                if (loadingEl) loadingEl.classList.remove("hidden");

                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤
                    const tariffsResponse = await fetch("/miniapp/subscription/tariffs", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ initData, init_data: initData })
                    });

                    if (!tariffsResponse.ok) {
                        const errorData = await tariffsResponse.json().catch(() => ({}));
                        throw new Error(errorData?.detail?.message || errorData?.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤");
                    }

                    const tariffsData = await tariffsResponse.json();
                    console.log("Tariffs data:", tariffsData);

                    // –ò—â–µ–º —Å—É—Ç–æ—á–Ω—ã–π —Ç–∞—Ä–∏—Ñ (is_daily: true)
                    const tariffs = tariffsData?.tariffs || [];
                    const dailyTariff = tariffs.find(t => t.is_daily || t.isDaily);
                    
                    console.log("Found daily tariff:", dailyTariff);
                    
                    if (!dailyTariff) {
                        showAlert("–°—É—Ç–æ—á–Ω—ã–π —Ç–∞—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.");
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
                    const balance = tariffsData?.balance_kopeks || tariffsData?.balanceKopeks || 0;
                    const price = dailyTariff.daily_price_kopeks || dailyTariff.dailyPriceKopeks || 0;
                    
                    if (balance < price) {
                        showAlert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${(price / 100).toFixed(0)}‚ÇΩ, —É –≤–∞—Å ${(balance / 100).toFixed(0)}‚ÇΩ`);
                        openModal("topup-modal");
                        return;
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–∫—É–ø–∫—É —Ç–∞—Ä–∏—Ñ–∞
                    const purchasePayload = {
                        initData,
                        init_data: initData,
                        tariffId: dailyTariff.id,
                        tariff_id: dailyTariff.id,
                        periodDays: 1,
                        period_days: 1
                    };

                    console.log("Purchase payload:", purchasePayload);

                    const purchaseResponse = await fetch("/miniapp/subscription/tariff/purchase", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(purchasePayload)
                    });

                    const purchaseResult = await purchaseResponse.json().catch(() => ({}));
                    console.log("Purchase result:", purchaseResult);

                    if (purchaseResponse.ok && purchaseResult.success !== false) {
                        showAlert(purchaseResult.message || "–°—É—Ç–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!");
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        await loadUserData();
                        updateUI();
                        renderDailySubscriptionStatus();
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
                        openModal("setup-modal");
                    } else {
                        const errorMsg = purchaseResult?.detail?.message 
                            || purchaseResult?.detail 
                            || purchaseResult?.message 
                            || "–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏";
                        showAlert(typeof errorMsg === 'string' ? errorMsg : "–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏");
                    }
                } catch (e) {
                    console.error("Activate subscription error:", e);
                    showAlert(e.message || "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
                } finally {
                    if (loadingEl) loadingEl.classList.add("hidden");
                }
            }

            function setupEventListeners() {
                // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
                const addClickHandler = (id, handler) => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener("click", handler);
                };

                // –ö–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–æ–≤
                addClickHandler("topup-btn", () => openModal("topup-modal"));
                addClickHandler("topup-link", () => openModal("topup-modal"));
                addClickHandler("setup-btn", handleSetupClick);
                addClickHandler("referral-btn", () => openModal("referral-modal"));
                addClickHandler("devices-btn", () => openModal("devices-modal"));
                addClickHandler("support-btn", () => openModal("support-modal"));

                // –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–æ–≤
                addClickHandler("close-topup", () => closeModal("topup-modal"));
                addClickHandler("close-setup", () => closeModal("setup-modal"));
                addClickHandler("close-referral", () => closeModal("referral-modal"));
                addClickHandler("close-devices", () => closeModal("devices-modal"));
                addClickHandler("close-support", () => closeModal("support-modal"));
                addClickHandler("close-history", () => closeModal("history-modal"));

                // –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
                addClickHandler("payments-link", (e) => {
                    e.preventDefault();
                    closeModal("support-modal");
                    renderTransactionHistory();
                    openModal("history-modal");
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–≤ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
                document.querySelectorAll(".modal-overlay").forEach((overlay) => {
                        overlay.addEventListener("click", (e) => {
                            if (e.target === overlay) {
                                overlay.classList.remove("active");
                            }
                        });
                    });

                // –í—ã–±–æ—Ä —Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
                document.querySelectorAll(".amount-option").forEach((option) => {
                        option.addEventListener("click", () => {
                        document.querySelectorAll(".amount-option").forEach((o) => o.classList.remove("selected"));
                            option.classList.add("selected");
                            selectedAmount = parseInt(option.dataset.amount);
                        const customInput = document.getElementById("custom-amount");
                        if (customInput) customInput.value = "";
                        });
                    });

                // –í–≤–æ–¥ —Å–≤–æ–µ–π —Å—É–º–º—ã
                const customAmountInput = document.getElementById("custom-amount");
                if (customAmountInput) {
                    customAmountInput.addEventListener("input", (e) => {
                        if (e.target.value) {
                            document.querySelectorAll(".amount-option").forEach((o) => o.classList.remove("selected"));
                            selectedAmount = parseInt(e.target.value) || 0;
                        }
                    });
                }

                // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                addClickHandler("pay-btn", handlePayment);
                addClickHandler("copy-key-btn", copySubscriptionKey);
                addClickHandler("copy-referral", copyReferralLink);
                addClickHandler("share-btn", shareReferralLink);
            }

            function openModal(id) {
                const modal = document.getElementById(id);
                if (modal) modal.classList.add("active");
            }

            function closeModal(id) {
                const modal = document.getElementById(id);
                if (modal) modal.classList.remove("active");
            }

            async function handlePayment() {
                if (selectedAmount < 50) {
                    showAlert("–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ 50‚ÇΩ");
                    return;
                }

                const payBtn = document.getElementById("pay-btn");
                const originalText = payBtn.innerHTML;
                payBtn.disabled = true;
                payBtn.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";

                try {
                    // –§–æ—Ä–º–∞—Ç API –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º miniapp
                    const payload = {
                        initData: tg?.initData,
                        method: selectedPaymentMethod,
                        amountKopeks: selectedAmount * 100,
                    };

                    const response = await fetch("/miniapp/payments/create", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();
                    
                    if (response.ok && data.payment_url) {
                        startBalancePolling();
                        closeModal("topup-modal");
                        
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É
                        if (tg?.openLink) {
                            tg.openLink(data.payment_url);
                        } else {
                            window.open(data.payment_url, '_blank');
                        }
                    } else {
                        const errorMsg = data?.detail || data?.error || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞";
                        showAlert(typeof errorMsg === 'string' ? errorMsg : "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞");
                    }
                } catch (error) {
                    console.error("Payment error:", error);
                    showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                } finally {
                    payBtn.disabled = false;
                    payBtn.innerHTML = originalText;
                }
            }

            async function copySubscriptionKey() {
                // –ò—â–µ–º URL –ø–æ–¥–ø–∏—Å–∫–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –¥–∞–Ω–Ω—ã—Ö
                const key = userData?.subscription_url 
                    || userData?.subscriptionUrl 
                    || userData?.subscription_key
                    || userData?.subscription?.subscription_url
                    || userData?.subscription?.url
                    || (userData?.links && userData.links.length > 0 ? userData.links[0] : null);
                
                console.log("Copy subscription key, userData:", userData);
                console.log("Found key:", key);
                
                if (key) {
                    try {
                        await navigator.clipboard.writeText(key);
                    const btn = document.getElementById("copy-key-btn");
                        if (btn) {
                            const span = btn.querySelector("span");
                            if (span) {
                                const originalText = span.textContent;
                                span.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
                    setTimeout(() => {
                                    span.textContent = originalText;
                    }, 2000);
                            }
                        }
                    } catch (e) {
                        showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
                    }
                } else {
                    showAlert("–ö–ª—é—á –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞.");
                }
            }

            async function copyReferralLink() {
                const linkInput = document.getElementById("referral-link");
                const link = linkInput?.value;
                if (link && link !== "–ó–∞–≥—Ä—É–∑–∫–∞...") {
                    try {
                    await navigator.clipboard.writeText(link);
                        showAlert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                    } catch (e) {
                        showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
                    }
                }
            }

            function shareReferralLink() {
                const linkInput = document.getElementById("referral-link");
                const link = linkInput?.value;
                if (link && link !== "–ó–∞–≥—Ä—É–∑–∫–∞..." && tg) {
                    tg.openTelegramLink(
                        "https://t.me/share/url?url=" +
                            encodeURIComponent(link) +
                            "&text=" +
                            encodeURIComponent("–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ VPN PLUS!"),
                    );
                }
            }
        </script>
    </body>
</html>
